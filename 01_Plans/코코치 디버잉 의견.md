from flask import Flask, jsonify, request, render_template, redirect, url_for, session
import json
import requests
import os
from datetime import datetime
from time_sync import get_korea_time
from data_manager import DataManager

# Flask 애플리케이션 및 데이터 관리자 초기화
app = Flask(__name__)
# 세션 암호화 키를 환경 변수에서 가져오도록 변경
app.secret_key = os.environ.get('FLASK_SECRET_KEY', 'default_aciu_quiz_secret_key')
data_manager = DataManager()

# OpenWeatherMap API 설정 (환경 변수 사용)
WEATHER_API_KEY = os.environ.get("OPENWEATHERMAP_API_KEY", "demo_key")
WEATHER_BASE_URL = "http://api.openweathermap.org/data/2.5/weather"

# Flask 애플리케이션 시작 시 데이터 로드
if data_manager.master_data is None:
    data_manager.load_master_csv()

# 모든 요청 이전에 세션 초기화를 보장하는 데코레이터
@app.before_request
def before_each_request():
    init_user_session()

def init_user_session():
    """사용자 세션 초기화"""
    if 'user_stats' not in session:
        session['user_stats'] = {
            'total_attempted': 0,
            'total_correct': 0,
            'total_accuracy': 0,
            'today_questions': 0,
            'today_correct': 0,
            'today_accuracy': 0,
            'last_study_date': None
        }
    
    if 'learning_progress' not in session:
        session['learning_progress'] = {
            'completed_questions': [],
            'correct_answers': [],
            'wrong_answers': [],
            'current_category': None,
            'current_mode': None
        }
    
    if 'study_history' not in session:
        session['study_history'] = []

def update_user_stats(is_correct, question_id, category, mode):
    """사용자 통계 업데이트"""
    
    # 오늘 날짜 확인
    today = datetime.now().strftime('%Y-%m-%d')
    
    # 마지막 학습 날짜 확인
    if session['user_stats']['last_study_date'] != today:
        # 새로운 날짜면 오늘 통계 초기화
        session['user_stats']['today_questions'] = 0
        session['user_stats']['today_correct'] = 0
        session['user_stats']['today_accuracy'] = 0
        session['user_stats']['last_study_date'] = today
    
    # 통계 업데이트
    session['user_stats']['total_attempted'] += 1
    session['user_stats']['today_questions'] += 1
    
    if is_correct:
        session['user_stats']['total_correct'] += 1
        session['user_stats']['today_correct'] += 1
        if question_id not in session['learning_progress']['correct_answers']:
            session['learning_progress']['correct_answers'].append(question_id)
    else:
        if question_id not in session['learning_progress']['wrong_answers']:
            session['learning_progress']['wrong_answers'].append(question_id)
    
    # 정답률 계산
    if session['user_stats']['total_attempted'] > 0:
        session['user_stats']['total_accuracy'] = round(
            (session['user_stats']['total_correct'] / session['user_stats']['total_attempted']) * 100, 1
        )
    if session['user_stats']['today_questions'] > 0:
        session['user_stats']['today_accuracy'] = round(
            (session['user_stats']['today_correct'] / session['user_stats']['today_questions']) * 100, 1
        )
    
    # 학습 기록 추가
    study_record = {
        'question_id': question_id,
        'is_correct': is_correct,
        'timestamp': get_korea_time()['formatted'],
        'category': category,
        'mode': mode
    }
    session['study_history'].append(study_record)
    
    # 세션 저장
    session.modified = True

def get_user_stats():
    """사용자 통계 반환"""
    return session.get('user_stats', {})

def get_learning_progress():
    """학습 진행 상황 반환"""
    return session.get('learning_progress', {})

@app.route('/')
def home():
    """메인 페이지를 렌더링합니다. 시즌1과 동일한 UI/UX를 제공합니다."""
    
    user_stats = get_user_stats()
    learning_progress = get_learning_progress()
    
    # 사용자 데이터
    user_settings = session.get('user_settings', {
        'user_name': '조대표님',
        'exam_date': '2025-12-15'
    })
    
    # 완료된 문제 수 계산 (정답 + 오답)
    completed_questions = len(learning_progress['correct_answers']) + len(learning_progress['wrong_answers'])
    
    # 통계 데이터 (세션 기반)
    stats = {
        'ins_questions': len(data_manager.master_data) if data_manager.master_data is not None else 0,
        'exam_questions': completed_questions,
        'total_questions': len(data_manager.master_data) if data_manager.master_data is not None else 0
    }
    
    # 진도 데이터 (세션 기반)
    progress_data = {
        'completed_questions': completed_questions,
        'overall_progress_rate': round((completed_questions / stats['total_questions']) * 100, 1) if stats['total_questions'] > 0 else 0,
        'accuracy_rate': user_stats.get('total_accuracy', 0)
    }
    
    # 일일 데이터 (세션 기반)
    daily_data = {
        'today_total_questions': user_stats.get('today_questions', 0),
        'today_correct_answers': user_stats.get('today_correct', 0),
        'today_accuracy_rate': user_stats.get('today_accuracy', 0)
    }
    
    return render_template('pages/home.html',
                         user_name=user_settings['user_name'],
                         exam_date=user_settings['exam_date'],
                         stats=stats,
                         progress=progress_data,
                         daily=daily_data)

@app.route('/api/v1/quiz/question/<mode>')
def get_quiz_question(mode):
    """퀴즈 모드별 문제를 가져옵니다."""
    try:
        category = request.args.get('category')
        questions = []
        
        if mode == 'basic':
            # 모든 카테고리의 문제를 합쳐서 랜덤 선택
            categories = ['property_insurance', 'specialty_insurance', 'liability_insurance', 'marine_insurance']
            
            for cat in categories:
                questions.extend(data_manager.get_questions_by_category(cat))
        elif mode == 'large-category' and category:
            questions = data_manager.get_questions_by_category(category)
        
        if questions:
            import random
            question = random.choice(questions)
            return jsonify({
                "status": "success",
                "data": question,
                "timestamp": get_korea_time()['formatted']
            })
        
        return jsonify({
            "status": "error",
            "message": f"Mode '{mode}' or category '{category}' not supported or no questions found",
            "timestamp": get_korea_time()['formatted']
        }), 400
        
    except Exception as e:
        return jsonify({
            "status": "error",
            "message": str(e),
            "timestamp": get_korea_time()['formatted']
        }), 500

@app.route('/api/v1/quiz/answer', methods=['POST'])
def check_answer():
    """정답 확인 및 통계 업데이트"""
    try:
        data = request.get_json()
        question_id = data.get('question_id')
        user_answer = data.get('user_answer')
        
        question = data_manager.get_question_by_id(question_id)
        if not question:
            return jsonify({
                "status": "error",
                "message": "Question not found",
                "timestamp": get_korea_time()['formatted']
            }), 404
        
        is_correct = user_answer == question['correct_answer']
        
        # 세션 통계 업데이트
        update_user_stats(is_correct, question_id, question['category'], question['mode'])
        
        user_stats = get_user_stats()
        
        return jsonify({
            "status": "success",
            "data": {
                "is_correct": is_correct,
                "user_answer": user_answer,
                "correct_answer": question['correct_answer'],
                "updated_stats": user_stats
            },
            "timestamp": get_korea_time()['formatted']
        })
        
    except Exception as e:
        return jsonify({
            "status": "error",
            "message": str(e),
            "timestamp": get_korea_time()['formatted']
        }), 500

@app.route('/quiz/<mode>')
def quiz(mode):
    """퀴즈 화면을 렌더링합니다. 시즌1과 동일한 UI/UX를 제공합니다."""
    quiz_mode = mode.replace('-', ' ').title()
    
    # 세션에 현재 모드와 카테고리 저장
    session['learning_progress']['current_mode'] = mode
    session.modified = True
    
    stats = get_user_stats()
    
    return render_template('pages/quiz.html',
                           quiz_mode=quiz_mode,
                           stats=stats)

@app.route('/quiz/category/<category>')
def quiz_by_category(category):
    """카테고리별 퀴즈 화면을 렌더링합니다."""
    # 세션에 현재 카테고리 저장
    session['learning_progress']['current_category'] = category
    session['learning_progress']['current_mode'] = 'large-category'
    session.modified = True
    
    return redirect(url_for('quiz', mode='large-category', category=category))

@app.route('/settings', methods=['GET', 'POST'])
def settings():
    """설정 화면을 렌더링합니다. 시즌1과 동일한 UI/UX를 제공합니다."""
    if request.method == 'POST':
        # 설정 저장 로직 (세션에 저장)
        session['user_settings'] = {
            'user_name': request.form.get('user-name', ''),
            'user_phone': request.form.get('user-phone', ''),
            'exam_subject': request.form.get('exam-subject', 'ACIU'),
            'exam_date': request.form.get('exam-date', '')
        }
        session.modified = True
        return redirect(url_for('home'))
    
    user_settings = session.get('user_settings', {
        'user_name': '조대표님',
        'user_phone': '010-1234-5678',
        'exam_subject': 'ACIU',
        'exam_date': '2025-12-15'
    })
    
    return render_template('pages/settings.html', user_settings=user_settings)

@app.route('/api/v1/hello', methods=['GET'])
def hello_api():
    """Hello API - V2.1 협업체계 테스트"""
    try:
        return jsonify({
            "message": "Hello ACIU!",
            "status": "success",
            "timestamp": get_korea_time()['formatted']
        })
    except Exception as e:
        return jsonify({
            "status": "error",
            "message": str(e),
            "timestamp": get_korea_time()['formatted']
        }), 500

@app.route('/api/v1/health')
def health_check():
    """시스템 상태 확인"""
    time_info = get_korea_time()
    
    data_status = "loaded" if data_manager.master_data is not None else "not_loaded"
    question_count = len(data_manager.master_data) if data_manager.master_data is not None else 0
    
    return jsonify({
        "status": "success",
        "data": {
            "service": "ACIU Quiz API v2.0",
            "status": "healthy",
            "version": "2.0.1",
            "environment": "development",
            "database": {
                "status": data_status,
                "questions_loaded": question_count,
                "categories_loaded": len(data_manager.get_all_categories()) if data_manager.master_data is not None else 0,
                "load_time": data_manager.load_time
            },
            "time_sync": {
                "status": "active",
                "current_time": time_info['formatted']
            }
        },
        "timestamp": time_info['formatted']
    })


if __name__ == '__main__':
    app.run(debug=True)
